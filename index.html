<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TierList</title>

<!-- Tailwind for quick styling (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- SortableJS for drag & drop (mouse + touch) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- html2canvas for export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
  :root{
    --bg:#0f0f0f;
    --panel:#0e0e0e;
    --muted:rgba(255,255,255,0.72);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  html,body,#root{height:100%}
  body{margin:0;background:linear-gradient(180deg,#070707 0%, var(--bg) 60%);color:#fff;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .container{max-width:980px;margin:18px auto;padding:12px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-weight:700;font-size:1.35rem;background:linear-gradient(90deg,#60a5fa,#c084fc);-webkit-background-clip:text;background-clip:text;color:transparent}
  .editable-title{background:transparent;border:0;color:transparent;padding:0;margin:0;outline:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#2563eb,#1e40af);box-shadow:0 6px 18px rgba(31,41,55,0.4);border:0;color:#fff;cursor:pointer}
  .btn.secondary{background:#111827}
  .panel{background:rgba(255,255,255,0.03);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.04)}
  .tiers{display:flex;flex-direction:column;gap:12px}
  .tier{border-radius:12px;padding:12px;border:2px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:8px;transition:box-shadow .18s,transform .14s}
  .tier.dragover{box-shadow:0 10px 30px rgba(0,0,0,0.6);transform:translateY(-4px)}
  .tier .title{display:flex;justify-content:space-between;align-items:center}
  .cells{min-height:120px;display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;padding:6px}
  .card{width:120px;height:170px;border-radius:12px;overflow:hidden;background:#222;flex:0 0 auto;box-shadow:0 8px 22px rgba(0,0,0,0.6);position:relative;cursor:grab;transition:transform .12s,box-shadow .12s}
  .card:active{cursor:grabbing}
  .card img{width:100%;height:100%;object-fit:cover;display:block}
  .card .label{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.75));color:#fff;font-size:13px;padding:8px;text-align:center;opacity:1}
  .counter{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);padding:6px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);font-size:12px}
  .pool-wrap{margin-top:12px}
  .pool-scroll{display:flex;gap:12px;overflow-x:auto;padding:10px 6px;scroll-snap-type:x mandatory}
  .card{scroll-snap-align:center}
  .help{color:var(--muted);font-size:13px}
  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* tier colors */
  .t1{border-color:#22c55e;background:linear-gradient(180deg,rgba(34,197,94,0.05),transparent)}
  .t2{border-color:#84cc16;background:linear-gradient(180deg,rgba(132,204,22,0.04),transparent)}
  .t3{border-color:#f59e0b;background:linear-gradient(180deg,rgba(245,158,11,0.04),transparent)}
  .t4{border-color:#fb923c;background:linear-gradient(180deg,rgba(251,146,60,0.04),transparent)}
  .t5{border-color:#ef4444;background:linear-gradient(180deg,rgba(239,68,68,0.04),transparent)}

  /* responsive */
  @media (max-width:640px){
    .card{width:140px;height:200px}
    .pool-scroll{padding-bottom:18px}
  }

  /* subtle animations */
  @keyframes popIn { from {opacity:0; transform:scale(.96) translateY(6px)} to {opacity:1; transform:none} }
  .card { animation: popIn .22s ease both }
  input[type="file"]{display:none}
  .hidden{display:none}
  .max-reached{opacity:0.7;pointer-events:none}
</style>
</head>
<body>
<div id="root" class="container">
  <header>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <h1 id="titleDisplay">TierList</h1>
        <input id="titleInput" class="editable-title" aria-label="Editar título" value="TierList" />
        <button id="editTitleBtn" class="btn secondary" title="Editar título">Editar</button>
      </div>
      <div class="help" id="subtitle">Clique em editar para personalizar o título.</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <label for="fileInput" id="addBtn" class="btn" title="Adicionar anime">Adicionar</label>
      <input id="fileInput" type="file" accept="image/*" />
      <button id="downloadBtn" class="btn" title="Baixar imagem da tier list">Baixar Tier List</button>
      <button id="resetBtn" class="btn secondary" title="Resetar">Resetar</button>
    </div>
  </header>

  <main class="panel" id="captureArea">
    <div class="tiers" id="tiersWrap">
      <!-- tiers injected -->
    </div>

    <section class="pool-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <strong>@toucabr</strong>
        <span class="help" id="poolHelp">Arraste as cartas para as tiers — máximo 30.</span>
      </div>
      <div class="pool-scroll" id="pool" tabindex="0" aria-label="@toucabr (scroll horizontal)"></div>
    </section>

    <footer id="footerNote">(as imagens ficam apenas no seu navegador; não enviamos nada)</footer>
  </main>
</div>

<script>
// Config
const MAX_CARDS = 30;
const STORAGE_KEY = 'anime_tierlist_custom_v2';

// Tiers definition
const TIERS = [
  {id:'t1',title:'100% TOP TIER', cls:'t1'},
  {id:'t2',title:'75% EXCELENTE', cls:'t2'},
  {id:'t3',title:'50% MÉDIO', cls:'t3'},
  {id:'t4',title:'25% FRACO', cls:'t4'},
  {id:'t5',title:'0% LIXO', cls:'t5'}
];

// Elements
const tiersWrap = document.getElementById('tiersWrap');
const poolEl = document.getElementById('pool');
const fileInput = document.getElementById('fileInput');
const addBtn = document.getElementById('addBtn');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');
const titleInput = document.getElementById('titleInput');
const editTitleBtn = document.getElementById('editTitleBtn');
const titleDisplay = document.getElementById('titleDisplay');
const subtitle = document.getElementById('subtitle');

// Utilities
function createEl(tag, attrs={}, children=[]){
  const el = document.createElement(tag);
  for(const k in attrs){
    if(k==='class') el.className = attrs[k];
    else if(k==='html') el.innerHTML = attrs[k];
    else el.setAttribute(k, attrs[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(ch=> { if(!ch) return; el.appendChild(typeof ch === 'string' ? document.createTextNode(ch) : ch); });
  return el;
}

function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

// Card factory
function makeCard(id, name, dataUrl, idx){
  const card = createEl('div',{class:'card', 'data-id':id, title:name});
  const img = createEl('img',{src:dataUrl, alt:name, draggable:'false'});
  img.onerror = ()=> { img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="300" height="400"><rect width="100%" height="100%" fill="#3d3d3d"/><text x="50%" y="50%" fill="#fff" font-size="20" text-anchor="middle" alignment-baseline="middle">Imagem inválida</text></svg>'); };
  const label = createEl('div',{class:'label'}, name);
  const counter = createEl('div',{class:'counter'}, String(idx+1));
  card.appendChild(img); card.appendChild(label); card.appendChild(counter);
  return card;
}

// State management
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){ console.warn(e) }
  const init = { pool: [], t1:[], t2:[], t3:[], t4:[], t5:[], title: 'TierList' };
  return init;
}

function saveState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){ console.warn(e) }
}

// Render tiers and pool
function render(){
  tiersWrap.innerHTML = '';
  const state = loadState();
  // Title
  titleDisplay.textContent = state.title || 'TierList';
  titleInput.value = state.title || 'TierList';

  // build tiers
  TIERS.forEach(t=>{
    const box = createEl('div',{class:`tier ${t.cls}`,'data-tier':t.id});
    const titleRow = createEl('div',{class:'title'});
    const strong = createEl('strong',{}, t.title);
    const hint = createEl('span',{class:'help'}, 'Arraste aqui');
    titleRow.appendChild(strong); titleRow.appendChild(hint);
    const cells = createEl('div',{class:'cells', id:`cells-${t.id}`});
    // populate from state
    (state[t.id]||[]).forEach((c, idx)=>{
      const card = makeCard(c.id, c.name, c.dataUrl, idx);
      cells.appendChild(card);
    });
    box.appendChild(titleRow);
    box.appendChild(cells);
    tiersWrap.appendChild(box);
  });

  // pool
  poolEl.innerHTML = '';
  (state.pool||[]).forEach((c, idx)=>{
    const card = makeCard(c.id, c.name, c.dataUrl, idx);
    poolEl.appendChild(card);
  });

  // Update add button disable
  const total = getTotalCards();
  if(total >= MAX_CARDS){
    addBtn.classList.add('max-reached');
    subtitle.textContent = `Máximo de ${MAX_CARDS} cartas alcançado.`;
  } else {
    addBtn.classList.remove('max-reached');
    subtitle.textContent = `Clique em editar para personalizar o título.`;
  }

  attachSortables();
}

function getTotalCards(){
  const state = loadState();
  let total = (state.pool||[]).length;
  TIERS.forEach(t => total += (state[t.id]||[]).length);
  return total;
}

// Attach Sortable
let instances = [];
function attachSortables(){
  instances.forEach(i=>i.destroy && i.destroy());
  instances = [];
  const options = {
    group: 'shared',
    animation: 180,
    swapThreshold: 0.65,
    onAdd: () => { setTimeout(persistFromDOM, 60); },
    onUpdate: () => { setTimeout(persistFromDOM, 60); },
    onRemove: () => { setTimeout(persistFromDOM, 60); },
    onEnd: (evt) => {
      const parent = evt.to.closest('.tier');
      if(parent){ parent.classList.add('dragover'); setTimeout(()=>parent.classList.remove('dragover'),400); }
    }
  };
  // pool horizontal scroll container children sortable (only items)
  instances.push(Sortable.create(poolEl, {...options, direction: 'horizontal'}));
  // tiers
  TIERS.forEach(t=>{
    const el = document.getElementById(`cells-${t.id}`);
    instances.push(Sortable.create(el, {...options}));
  });
}

// Persist by reading DOM
function persistFromDOM(){
  const state = { pool: [], title: titleInput.value || 'TierList' };
  // pool
  state.pool = Array.from(poolEl.children).map(ch => ({
    id: ch.getAttribute('data-id'),
    name: ch.getAttribute('title'),
    dataUrl: ch.querySelector('img').src
  }));
  TIERS.forEach(t=>{
    const el = document.getElementById(`cells-${t.id}`);
    state[t.id] = Array.from(el.children).map(ch => ({
      id: ch.getAttribute('data-id'),
      name: ch.getAttribute('title'),
      dataUrl: ch.querySelector('img').src
    }));
  });
  saveState(state);
  renderCounters();
}

// Render counters (position numbers)
function renderCounters(){
  // pool
  Array.from(poolEl.children).forEach((ch, idx)=> {
    const cnt = ch.querySelector('.counter');
    if(cnt) cnt.textContent = String(idx+1);
  });
  // tiers
  TIERS.forEach(t=>{
    const el = document.getElementById(`cells-${t.id}`);
    if(!el) return;
    Array.from(el.children).forEach((ch, idx)=>{
      const cnt = ch.querySelector('.counter');
      if(cnt) cnt.textContent = String(idx+1);
    });
  });
}

// Add new card flow
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const total = getTotalCards();
  if(total >= MAX_CARDS){
    alert(`Máximo de ${MAX_CARDS} cartas atingido.`);
    fileInput.value = '';
    return;
  }
  const name = prompt('Nome do anime (deixe em branco para usar o nome do arquivo):', file.name.replace(/\.[^/.]+$/, ''));
  const dataUrl = await readFileAsDataURL(file);
  const state = loadState();
  const id = 'c' + Date.now();
  state.pool = state.pool || [];
  state.pool.unshift({ id, name: name || file.name, dataUrl });
  saveState(state);
  fileInput.value = '';
  render();
});

// Title edit
editTitleBtn.addEventListener('click', ()=>{
  const current = titleInput.value || 'TierList';
  const newTitle = prompt('Digite o título da sua TierList:', current);
  if(newTitle !== null){
    titleInput.value = newTitle.trim() || 'TierList';
    persistFromDOM();
  }
});

// Download capture
downloadBtn.addEventListener('click', async ()=>{
  downloadBtn.disabled = true;
  const prevText = downloadBtn.textContent;
  downloadBtn.textContent = 'Gerando...';
  try{
    const area = document.getElementById('captureArea');
    // ensure area has explicit background to avoid white capture
    const prevBg = area.style.backgroundColor;
    area.style.backgroundColor = getComputedStyle(document.body).backgroundColor || '#0f0f0f';
    const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor: getComputedStyle(area).backgroundColor || '#0f0f0f' });
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = (titleInput.value || 'TierList').replace(/\s+/g,'-').toLowerCase() + '.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
    area.style.backgroundColor = prevBg;
  }catch(e){
    console.error(e);
    alert('Erro ao gerar imagem. Tente novamente.');
  }
  downloadBtn.disabled = false;
  downloadBtn.textContent = prevText;
});

// Reset
resetBtn.addEventListener('click', ()=>{
  if(!confirm('Resetar tudo? Isso removerá todas as cartas criadas localmente.')) return;
  localStorage.removeItem(STORAGE_KEY);
  render();
});

// Helpers
function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

// initial render
(function init(){
  // ensure state exists
  const s = loadState();
  if(!s.pool) s.pool = [];
  if(!s.t1) s.t1 = [];
  if(!s.title) s.title = 'TierList';
  saveState(s);
  render();
  // keyboard hint for pool scroll
  poolEl.addEventListener('wheel', (e)=>{
    if(Math.abs(e.deltaX) < Math.abs(e.deltaY)){
      // translate vertical wheel to horizontal scroll for convenience
      poolEl.scrollLeft += e.deltaY;
      e.preventDefault();
    }
  }, { passive: false });
})();
</script>
</body>
</html>
